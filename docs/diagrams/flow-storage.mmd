sequenceDiagram
    participant User
    participant Client
    participant ServerAction
    participant StorageLib as lib/storage
    participant GCS as Google Cloud Storage
    participant DB as PostgreSQL

    %% Upload Flow
    rect rgb(240, 248, 255)
    note right of User: Upload Flow
    User->>Client: Select File
    Client->>ServerAction: POST /upload (FormData)
    ServerAction->>ServerAction: Validate File Type/Size
    ServerAction->>StorageLib: uploadObject(key, buffer)
    StorageLib->>GCS: Stream Upload
    GCS-->>StorageLib: Success
    ServerAction->>DB: Create File Record (key, ownerId)
    ServerAction-->>Client: Return File ID
    end

    %% Access Flow
    rect rgb(255, 240, 245)
    note right of User: Access Flow (Private)
    User->>Client: Request File
    Client->>ServerAction: getFileUrl(fileId)
    ServerAction->>DB: Check Permission (Owner/Shared)
    
    alt Allowed
        ServerAction->>StorageLib: getSignedUrlForKey(key)
        StorageLib->>GCS: Generate V4 Signed URL
        StorageLib-->>ServerAction: Signed URL
        ServerAction-->>Client: Redirect to Signed URL
    else Denied
        ServerAction-->>Client: 403 Forbidden
    end
    end
