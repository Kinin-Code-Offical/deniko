substitutions:
  _REGION: "europe-west1"
  _AR_REPO: "deniko"
  _API_IMAGE: "deniko-api"
  _MIGRATE_IMAGE: "deniko-db-migrate"
  _API_SERVICE: "deniko-api"
  _MIGRATE_JOB: "deniko-db-migrate"

steps:
  - id: "Build API"
    name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "-f"
      - "apps/api/Dockerfile"
      - "-t"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_IMAGE}:$BUILD_ID"
      - "-t"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_IMAGE}:latest"
      - "."

  - id: "Push API ($BUILD_ID)"
    name: "gcr.io/cloud-builders/docker"
    waitFor: ["Build API"]
    args:
      - "push"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_IMAGE}:$BUILD_ID"

  - id: "Push API (latest)"
    name: "gcr.io/cloud-builders/docker"
    waitFor: ["Build API"]
    args:
      - "push"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_IMAGE}:latest"

  - id: "Build Migrate Image"
    name: "gcr.io/cloud-builders/docker"
    waitFor: ["Build API"]
    args:
      - "build"
      - "-f"
      - "apps/api/Dockerfile"
      - "--target"
      - "migrate"
      - "-t"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MIGRATE_IMAGE}:$BUILD_ID"
      - "-t"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MIGRATE_IMAGE}:latest"
      - "."

  - id: "Push Migrate Image ($BUILD_ID)"
    name: "gcr.io/cloud-builders/docker"
    waitFor: ["Build Migrate Image"]
    args:
      - "push"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MIGRATE_IMAGE}:$BUILD_ID"

  - id: "Push Migrate Image (latest)"
    name: "gcr.io/cloud-builders/docker"
    waitFor: ["Build Migrate Image"]
    args:
      - "push"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MIGRATE_IMAGE}:latest"

  - id: "Update migrate job image"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk:slim"
    waitFor: ["Push Migrate Image ($BUILD_ID)"]
    entrypoint: "gcloud"
    args:
      - "run"
      - "jobs"
      - "update"
      - "${_MIGRATE_JOB}"
      - "--region"
      - "${_REGION}"
      - "--image"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MIGRATE_IMAGE}:$BUILD_ID"

  - id: "Execute migrate job"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk:slim"
    waitFor: ["Update migrate job image"]
    entrypoint: "gcloud"
    args:
      - "run"
      - "jobs"
      - "execute"
      - "${_MIGRATE_JOB}"
      - "--region"
      - "${_REGION}"
      - "--wait"

  - id: "Deploy API"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk:slim"
    waitFor: ["Execute migrate job"]
    entrypoint: "gcloud"
    args:
      - "run"
      - "deploy"
      - "${_API_SERVICE}"
      - "--region"
      - "${_REGION}"
      - "--image"
      - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_IMAGE}:$BUILD_ID"

images:
  - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_IMAGE}:$BUILD_ID"
  - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_IMAGE}:latest"
  - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MIGRATE_IMAGE}:$BUILD_ID"
  - "${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MIGRATE_IMAGE}:latest"

options:
  logging: CLOUD_LOGGING_ONLY

timeout: "1800s"
